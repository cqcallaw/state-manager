A simple finite state machine implementation
